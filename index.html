<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Oculus Quest Demo</title>
    <meta name="description" content="Oculus Quest Demo">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/fernandojsg/aframe-teleport-controls/master/dist/aframe-teleport-controls.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>
    <style>
        .light{
            display: none;
        }
    </style>
</head>
<script>
    AFRAME.registerComponent('input-listener', {
        init:
            function () { 
                var p = new THREE.Vector3(200,300,500);
                console.log(p)
                //コントローラのグリップボタンを押しているかどうかを保持
                this.el.grip = false;

                //トリガーを押した時に球を発射 
                document.addEventListener('keydown', function(event) {
                    
                    if(event.code !== "Space"){
                        return false;
                    }
                 //コントローラの位置を取得(thisはコントローラ)
                 console.log(document.querySelector('a-scene').camera.el.object3D.position)
                 var point = document.querySelector('a-scene').camera.el.object3D.position; 
                    //ボールを生成
                    var ball = document.createElement('a-sphere');
                    ball.setAttribute('class', 'ball');
                    ball.setAttribute('scale', '0.2 0.2 0.2');
                    ball.setAttribute('position', point);
                    //dynamic-bodyを設定することで物理演算をさせる
                    ball.setAttribute('dynamic-body', 'shape: sphere; sphereRadius:0.2; ');
                    //球を発射するときの向きと大きさを設定(好みに応じて変更) 
                    var force = new THREE.Vector3(point.x, point.y, point.z);
                    force.multiplyScalar(2000);
                    // //レイキャスターの向きはコントローラを原点としたローカル座標系なのでワールド座標に変換                   
                    // ball.force = this.object3D.localToWorld(force);
                    //上記の設定を済ませた球をシーンに登場させる
                    var scene = document.querySelector('a-scene');
                    scene.appendChild(ball);
                    //物理関係の設定が済んだタイミングで球を飛ばす 
                    ball.addEventListener('body-loaded', function (e) {
                        //ボールの位置を取得(ここでのthisはballを示す)
                        var p = this.object3D.position;
                        //加える力は先ほど計算したものを使用
                        var f = this.force;
                        //球に力を加えて飛ばす
                        this.body.applyForce(
                            new CANNON.Vec3(f.x, f.y, f.z),
                            new CANNON.Vec3(p.x, p.y, p.z)
                        );
                    });
                });
                this.el.addEventListener('triggerdown', function (e) {
                    //コントローラの位置を取得(thisはコントローラ)
                    var point = this.object3D.getWorldPosition();
                    //ボールを生成
                    var ball = document.createElement('a-sphere');
                    ball.setAttribute('class', 'ball');
                    ball.setAttribute('scale', '0.2 0.2 0.2');
                    ball.setAttribute('position', point);
                    //dynamic-bodyを設定することで物理演算をさせる
                    ball.setAttribute('dynamic-body', 'shape: sphere; sphereRadius:0.2; ');
                    //コントローラのレイキャスターの向きを取得
                    var dir = this.getAttribute("raycaster").direction;
                    //球を発射するときの向きと大きさを設定(好みに応じて変更) 
                    var force = new THREE.Vector3(dir.x, dir.y, dir.z);
                    force.multiplyScalar(2000);
                    //レイキャスターの向きはコントローラを原点としたローカル座標系なのでワールド座標に変換                   
                    ball.force = this.object3D.localToWorld(force);
                    //上記の設定を済ませた球をシーンに登場させる
                    var scene = document.querySelector('a-scene');
                    scene.appendChild(ball);
                    //物理関係の設定が済んだタイミングで球を飛ばす 
                    ball.addEventListener('body-loaded', function (e) {
                        //ボールの位置を取得(ここでのthisはballを示す)
                        var p = this.object3D.position;
                        //加える力は先ほど計算したものを使用
                        var f = this.force;
                        //球に力を加えて飛ばす
                        this.body.applyForce(
                            new CANNON.Vec3(f.x, f.y, f.z),
                            new CANNON.Vec3(p.x, p.y, p.z)
                        );
                    });
                });

                //グリップボタンを押した時に呼ばれる
                this.el.addEventListener('gripdown', function (e) {
                    //グリップボタン押下中
                    this.grip = true;
                });

                //グリップボタンを話した時に呼ばれる
                this.el.addEventListener('gripup', function (e) {
                    //グリップボタン押下終了
                    this.grip = false;
                });

                //レイキャスターが何かしらのオブジェクトにぶつかった時
                this.el.addEventListener('raycaster-intersection', function (e) {
                    //交差したオブジェクトのうち0番目を覚えておく(本当はもうちょっと上手にやるべき)
                    this.selectedObj = e.detail.els[0];
                });

                //レイキャスターとオブジェクトとの接触完了
                this.el.addEventListener('raycaster-intersection-cleared', function (e) {
                    //レイキャスターと接触しているオブジェクトの情報をクリア
                    this.selectedObj = null;
                });

                //Aボタンを押した時(球を全部削除する) 
                this.el.addEventListener('abuttondown', function (e) {
                    //a-sceneに存在する球を全て取得
                    var els = document.querySelectorAll('.ball');
                    //球を削除
                    for (var i = 0; i < els.length; i++) {
                        els[i].parentNode.removeChild(els[i]);
                    }
                });

                //xボタンを押した時 
                this.el.addEventListener('xbuttondown', function (e) {
                    //行き先をポインティング  
                    this.emit('teleportstart');
                });

                //Xボタンを離した時 
                this.el.addEventListener('xbuttonup', function (e) {
                    //ポイントした場所にジャンプ
                    this.emit('teleportend');
                });
            },

        //毎フレーム呼ばれる
        tick:
            function () {
                if (!this.el.selectedObj) { return; }
                if (!this.el.grip) { return; }
                //レイキャスターの向きを取得 (this.elはコントローラを示す)
                var ray = this.el.getAttribute("raycaster").direction;
                //レイキャスターの先端の位置を1.2m手前とし、そのワールド座標を計算 
                var p = new THREE.Vector3(ray.x, ray.y, ray.z);
                console.log(p)
                p.normalize();
                p.multiplyScalar(1.2);
                this.el.object3D.localToWorld(p);
                //レイキャスターの先端に、選択中のオブジェクトを追従させる。
                this.el.selectedObj.object3D.position.set(p.x, p.y, p.z);
            }
    });


</script>

<body>
    <a-scene physics="debug: false; gravity: 0; restitution: 0.9; " background="color: #AAAAAA">
        <a-entity id="cameraRig">
            <a-entity id="head" camera wasd-controls look-controls position="0 1.6 0">
            </a-entity>
            <a-entity id="ctlL" teleport-controls="cameraRig: #cameraRig; teleportOrigin: #head; startEvents: teleportstart; endEvents: teleportend" raycaster="objects: .collidable; far:1.2;" laser-controls="hand: left" input-listener>
                <a-text value="Trigger: shoot a ball\nGrip: Grab large object\nX: Teleport" position="0 0.05 0" rotation="-90 0 0" scale="0.1 0.1 0.1" align="center" color="#FFFFFF"></a-text>
            </a-entity>
            <a-entity id="ctlR" raycaster="objects: .collidable; far:1.2;" laser-controls="hand: right" input-listener>
                <a-text value="Trigger: shoot a ball\nGrip: Grab large object\nA: Remove small balls" position="0 0.05 0" rotation="-90 0 0" scale="0.1 0.1 0.1" align="center" color="#FFFFFF"></a-text>
            </a-entity>
        </a-entity>
        
        <a-entity id="top-light-1" class="light" light="type: point; intensity:1; distance: 45; decay: 12" position="0 11 5"></a-entity>
        <a-entity id="top-light-2" class="light" light="type: point; intensity:1; distance: 45; decay: 12" position="0 11 10"></a-entity>
        <a-entity id="top-light-3" class="light" light="type: point; intensity:1; distance: 45; decay: 12" position="0 11 -10"></a-entity>
        <a-entity id="top-light-4" class="light" light="type: point; intensity:1; distance: 45; decay: 12" position="0 11 -30"></a-entity>
        <a-entity id="top-light-5" class="light" light="type: point; intensity:1; distance: 45; decay: 12" position="0 11 -50"></a-entity>
        <a-entity id="top-light-6" class="light" light="type: point; intensity:1; distance: 80; decay: 15" position="0 11 -70"></a-entity>
        <a-entity id="top-light-7" class="light" light="type: point; intensity:1; distance: 80; decay: 15" position="0 11 -90"></a-entity>
        <a-entity id="top-light-8" class="light" light="type: point; intensity:1; distance: 80; decay: 15" position="0 11 -110"></a-entity>
        <a-entity id="top-light-9" class="light" light="type: point; intensity:1; distance: 80; decay: 15" position="0 11 -130"></a-entity>
        <a-entity id="top-light-10" class="light" light="type: point; intensity:1; distance: 80; decay: 15" position="0 11 -150"></a-entity>
        <a-entity id="top-light-11" class="light" light="type: point; intensity:1; distance: 80; decay: 15" position="0 11 -170"></a-entity>

        <a-entity id="bottom-light-1" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 5"></a-entity>
        <a-entity id="bottom-light-2" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 10"></a-entity>
        <a-entity id="bottom-light-3" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 -10"></a-entity>
        <a-entity id="bottom-light-4" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 -30"></a-entity>
        <a-entity id="bottom-light-5" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 -50"></a-entity>
        <!-- <a-entity id="bottom-light-6" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 -70"></a-entity>
        <a-entity id="bottom-light-7" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 -90"></a-entity>
        <a-entity id="bottom-light-8" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 -110"></a-entity>
        <a-entity id="bottom-light-9" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 -130"></a-entity>
        <a-entity id="bottom-light-10" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 -150"></a-entity>
        <a-entity id="bottom-light-11" class="light" light="type: point; intensity:1; distance: 50; decay: 12" position="0 0.5 -170"></a-entity> -->

        <!-- <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
        <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
        <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder> -->
        <a-plane position="-18 4 -80" rotation="0 90 0" width="200" height="16" color="#e0e0e0"></a-plane> // left
        <a-plane position="0 12 -80" rotation="90 -90 0" width="200" height="36" color="#e0e0e0"></a-plane> // top
        <a-plane position="18 4 -80" rotation="0 -90 0" width="200" height="16" color="#e0e0e0"></a-plane> // right
        <a-plane position="0 4 -180" rotation="0 0 0" width="36" height="16" color="#e0e0e0"></a-plane> // front
        <a-plane position="0 4 20" rotation="0 180 0" width="36" height="16" color="#e0e0e0"></a-plane> // back
        <a-plane position="0 -4 -80" rotation="-90 -90 0" width="200" height="36" color="#e0e0e0"></a-plane> // bottom
    </a-scene>
    <script>
        const topLight1 = document.getElementById("top-light-1");
        const topLight2 = document.getElementById("top-light-2");
        const topLight3 = document.getElementById("top-light-3");
        const topLight4 = document.getElementById("top-light-4");
        const topLight5 = document.getElementById("top-light-5");
        const topLight6 = document.getElementById("top-light-6");
        const topLight7 = document.getElementById("top-light-7");
        const topLight8 = document.getElementById("top-light-8");
        const topLight9 = document.getElementById("top-light-9");
        const topLight10 = document.getElementById("top-light-10");
        const topLight11 = document.getElementById("top-light-11");
        const bottomLight1 = document.getElementById("bottom-light-1");
        const bottomLight2 = document.getElementById("bottom-light-2");
        const bottomLight3 = document.getElementById("bottom-light-3");
        const bottomLight4 = document.getElementById("bottom-light-4");
        const bottomLight5 = document.getElementById("bottom-light-5");
        // const bottomLight6 = document.getElementById("bottom-light-6");
        // const bottomLight7 = document.getElementById("bottom-light-7");
        // const bottomLight8 = document.getElementById("bottom-light-8");
        // const bottomLight9 = document.getElementById("bottom-light-9");
        // const bottomLight10 = document.getElementById("bottom-light-10");
        // const bottomLight11 = document.getElementById("bottom-light-11");
        turnOffAllLight();
        const topLightArray=[
            topLight1,  
            topLight2,  
            topLight3,  
            topLight4,  
            topLight5,  
            topLight6,  
            topLight7,  
            topLight8,  
            topLight9,  
            topLight10, 
            topLight11,
        ];
        const bottomLightArray=[
            bottomLight1,  
            bottomLight2,  
            bottomLight3,  
            bottomLight4,  
            bottomLight5,  
            // bottomLight6,  
            // bottomLight7,  
            // bottomLight8,  
            // bottomLight9,  
            // bottomLight10, 
            // bottomLight11, 
        ];
        function startTurnOnLights(){
            for (let index =0; index < topLightArray.length; index++) {
            const topLight = topLightArray[index];
            const bottomLight= bottomLightArray[index];
            let time =2000+150*index;
            if(index<3){
                time =300*index;
            }
            if(index>2&&index<4){
                time =500*index;
            }
            if(index>3&&index<7){
                time =700+350*index;
            }
            if(index>6&&index<9){
                time =1500+200*index;
            }
            setTimeout(() => {
                topLight.setAttribute("visible",true);
                bottomLight.setAttribute("visible",true);
            }, time);
        }

        }

        function turnOffAllLight(){
            topLight1.setAttribute("visible",false);
            topLight2.setAttribute("visible",false);
            topLight3.setAttribute("visible",false);
            topLight4.setAttribute("visible",false);
            topLight5.setAttribute("visible",false);
            topLight6.setAttribute("visible",false);
            topLight7.setAttribute("visible",false);
            topLight8.setAttribute("visible",false);
            topLight9.setAttribute("visible",false);
            topLight10.setAttribute("visible",false);
            topLight11.setAttribute("visible",false);
            bottomLight1.setAttribute("visible",false);
            bottomLight2.setAttribute("visible",false);
            bottomLight3.setAttribute("visible",false);
            bottomLight4.setAttribute("visible",false);
            bottomLight5.setAttribute("visible",false);
            // bottomLight6.setAttribute("visible",false);
            // bottomLight7.setAttribute("visible",false);
            // bottomLight8.setAttribute("visible",false);
            // bottomLight9.setAttribute("visible",false);
            // bottomLight10.setAttribute("visible",false);
            // bottomLight11.setAttribute("visible",false);
        }

        init();


        function init(){
            startTurnOnLights();
        }
    </script>
</body>
</html>

</html>